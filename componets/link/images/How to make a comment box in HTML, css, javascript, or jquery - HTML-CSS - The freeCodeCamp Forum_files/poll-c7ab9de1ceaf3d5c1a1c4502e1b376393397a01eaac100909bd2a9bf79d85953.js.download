Ember.TEMPLATES["javascripts/modal/poll-ui-builder"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[4,"d-modal-body",null,[["title","class"],["poll.ui_builder.title","poll-ui-builder"]],{"statements":[[0,"  "],[7,"form"],[11,"class","poll-ui-builder-form form-horizontal"],[9],[0,"\\n    "],[7,"div"],[11,"class","input-group poll-select"],[9],[0,"\\n      "],[7,"label"],[11,"class","input-group-label"],[9],[1,[29,"i18n",["poll.ui_builder.poll_type.label"],null],false],[10],[0,"\\n      "],[1,[29,"combo-box",null,[["content","value","allowInitialValueMutation","valueAttribute"],[[25,["pollTypes"]],[25,["pollType"]],true,"value"]]],false],[0,"\\n    "],[10],[0,"\\n\\n    "],[7,"div"],[11,"class","input-group poll-select"],[9],[0,"\\n      "],[7,"label"],[11,"class","input-group-label"],[9],[1,[29,"i18n",["poll.ui_builder.poll_result.label"],null],false],[10],[0,"\\n      "],[1,[29,"combo-box",null,[["content","value","allowInitialValueMutation","valueAttribute"],[[25,["pollResults"]],[25,["pollResult"]],true,"value"]]],false],[0,"\\n    "],[10],[0,"\\n\\n\\n"],[4,"if",[[25,["showMinMax"]]],null,{"statements":[[0,"      "],[7,"div"],[11,"class","input-group poll-number"],[9],[0,"\\n        "],[1,[29,"input-tip",null,[["validation"],[[25,["minMaxValueValidation"]]]]],false],[0,"\\n        "],[7,"label"],[11,"class","input-group-label"],[9],[1,[29,"i18n",["poll.ui_builder.poll_config.min"],null],false],[10],[0,"\\n        "],[1,[29,"input",null,[["type","value","valueAttribute","class"],["number",[25,["pollMin"]],"value","poll-options-min"]]],false],[0,"\\n      "],[10],[0,"\\n\\n\\n      "],[7,"div"],[11,"class","input-group poll-number"],[9],[0,"\\n        "],[7,"label"],[11,"class","input-group-label"],[9],[1,[29,"i18n",["poll.ui_builder.poll_config.max"],null],false],[10],[0,"\\n        "],[1,[29,"input",null,[["type","value","valueAttribute","class"],["number",[25,["pollMax"]],"value","poll-options-max"]]],false],[0,"\\n      "],[10],[0,"\\n\\n"],[4,"if",[[25,["isNumber"]]],null,{"statements":[[0,"        "],[7,"div"],[11,"class","input-group poll-number"],[9],[0,"\\n          "],[7,"label"],[11,"class","input-group-label"],[9],[1,[29,"i18n",["poll.ui_builder.poll_config.step"],null],false],[10],[0,"\\n          "],[1,[29,"input",null,[["type","value","valueAttribute","min","class"],["number",[25,["pollStep"]],"value","1","poll-options-step"]]],false],[0,"\\n          "],[1,[29,"input-tip",null,[["validation"],[[25,["minStepValueValidation"]]]]],false],[0,"\\n        "],[10],[0,"\\n"]],"parameters":[]},null]],"parameters":[]},null],[0,"\\n"],[4,"unless",[[25,["isNumber"]]],null,{"statements":[[0,"      "],[7,"div"],[11,"class","input-group poll-textarea"],[9],[0,"\\n        "],[7,"label"],[9],[1,[29,"i18n",["poll.ui_builder.poll_options.label"],null],false],[10],[0,"\\n        "],[1,[29,"textarea",null,[["value","autocomplete"],[[25,["pollOptions"]],"discourse"]]],false],[0,"\\n        "],[1,[29,"input-tip",null,[["validation"],[[25,["minNumOfOptionsValidation"]]]]],false],[0,"\\n      "],[10],[0,"\\n"]],"parameters":[]},null],[0,"\\n    "],[7,"div"],[11,"class","input-group poll-checkbox"],[9],[0,"\\n      "],[7,"label"],[9],[0,"\\n        "],[1,[29,"input",null,[["type","checked"],["checkbox",[25,["publicPoll"]]]]],false],[0,"\\n        "],[1,[29,"i18n",["poll.ui_builder.poll_public.label"],null],false],[0,"\\n      "],[10],[0,"\\n    "],[10],[0,"\\n\\n    "],[7,"div"],[11,"class","input-group poll-checkbox"],[9],[0,"\\n      "],[7,"label"],[9],[0,"\\n        "],[1,[29,"input",null,[["type","checked"],["checkbox",[25,["autoClose"]]]]],false],[0,"\\n        "],[1,[29,"i18n",["poll.ui_builder.automatic_close.label"],null],false],[0,"\\n      "],[10],[0,"\\n    "],[10],[0,"\\n\\n"],[4,"if",[[25,["autoClose"]]],null,{"statements":[[0,"      "],[7,"div"],[11,"class","input-group"],[9],[0,"\\n        "],[1,[29,"date-picker-future",null,[["value","containerId"],[[25,["date"]],"date-container"]]],false],[0,"\\n        "],[1,[29,"input",null,[["type","value"],["time",[25,["time"]]]]],false],[0,"\\n        "],[7,"div"],[11,"id","date-container"],[9],[10],[0,"\\n      "],[10],[0,"\\n"]],"parameters":[]},null],[0,"  "],[10],[0,"\\n"]],"parameters":[]},null],[0,"\\n"],[7,"div"],[11,"class","modal-footer"],[9],[0,"\\n  "],[1,[29,"d-button",null,[["action","icon","class","label","disabled"],[[29,"action",[[24,0,[]],"insertPoll"],null],"chart-bar","btn-primary","poll.ui_builder.insert",[25,["disableInsert"]]]]],false],[0,"\\n"],[10],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/modal/poll-ui-builder"}}),define("discourse/plugins/poll/widgets/discourse-poll",["exports","discourse/widgets/widget","virtual-dom","discourse-common/lib/icon-library","discourse/widgets/raw-html","discourse/lib/ajax","discourse/lib/ajax-error","discourse/plugins/poll/lib/even-round","discourse/widgets/post","discourse/lib/round","discourse/lib/formatter"],function(t,e,l,o,n,i,s,r,a,u,p){"use strict";function c(t){var e=$("<span>"+t.html+"</span>");return e.find(".discourse-local-date").each(function(t,e){$(e).applyLocalDates()}),new n.default({html:"<span>"+e.html()+"</span>"})}function d(t){return new n.default({html:'<span class="info-text">'+t+"</span>"})}function f(t){return(0,i.ajax)("/polls/voters.json",{data:t}).catch(function(t){t?(0,s.popupAjaxError)(t):bootbox.alert(I18n.t("poll.error_while_fetching_voters"))})}Object.defineProperty(t,"__esModule",{value:!0}),(0,e.createWidget)("discourse-poll-option",{tagName:"li",buildAttributes:function(t){return{"data-poll-option-id":t.option.id}},html:function(t){var e=[],l=t.option,n=t.vote,i=n.includes(l.id);return t.isMultiple?e.push((0,o.iconNode)(i?"far-check-square":"far-square")):e.push((0,o.iconNode)(i?"circle":"far-circle")),e.push(" "),e.push(c(l)),e},click:function(t){0===$(t.target).closest("a").length&&this.sendWidgetAction("toggleOption",this.attrs.option)}}),(0,e.createWidget)("discourse-poll-load-more",{tagName:"div.poll-voters-toggle-expand",buildKey:function(t){return"load-more-"+t.optionId},defaultState:function(){return{loading:!1}},html:function(t,e){return e.loading?(0,l.h)("div.spinner.small"):(0,l.h)("a",(0,o.iconNode)("chevron-down"))},click:function(){var t=this.state;if(!t.loading)return t.loading=!0,this.sendWidgetAction("loadMore").finally(function(){return t.loading=!1})}}),(0,e.createWidget)("discourse-poll-voters",{tagName:"ul.poll-voters-list",buildKey:function(t){return"poll-voters-"+t.optionId},defaultState:function(){return{loaded:"new",voters:[],page:1}},fetchVoters:function(){var t=this,e=this.attrs,l=this.state;if("loading"!==l.loaded)return l.loaded="loading",f({post_id:e.postId,poll_name:e.pollName,option_id:e.optionId,page:l.page}).then(function(o){l.loaded="loaded",l.page+=1;var n="number"===e.pollType?o.voters:o.voters[e.optionId],i=new Set(l.voters.map(function(t){return t.username}));n.forEach(function(t){i.has(t.username)||(i.add(t.username),l.voters.push(t))}),t.scheduleRerender()})},loadMore:function(){return this.fetchVoters()},html:function(t,e){t.voters&&"new"===e.loaded&&(e.voters=t.voters);var o=e.voters.map(function(t){return(0,l.h)("li",[(0,a.avatarFor)("tiny",{username:t.username,template:t.avatar_template})," "])});return e.voters.length<t.totalVotes&&o.push(this.attach("discourse-poll-load-more",t)),(0,l.h)("div.poll-voters",o)}}),(0,e.createWidget)("discourse-poll-standard-results",{tagName:"ul.results",buildKey:function(t){return"poll-standard-results-"+t.id},defaultState:function(){return{loaded:!1}},fetchVoters:function(){var t=this,e=this.attrs,l=this.state;return f({post_id:e.post.id,poll_name:e.poll.get("name")}).then(function(e){l.voters=e.voters,t.scheduleRerender()})},html:function(t,e){var o=this,n=t.poll,i=n.get("options");if(i){var s=n.get("voters"),a=n.get("public"),u=_.clone(i).sort(function(t,e){return t.votes<e.votes?1:t.votes===e.votes?t.html<e.html?-1:1:-1});a&&!e.loaded&&(e.voters=n.get("preloaded_voters"),e.loaded=!0);var p=0===s?Array(u.length).fill(0):u.map(function(t){return 100*t.votes/s}),d=t.isMultiple?p.map(Math.floor):(0,r.default)(p);return u.map(function(i,s){var r=[],u=d[s].toString(),p=(t.vote||[]).includes(i.id);return r.push((0,l.h)("div.option",(0,l.h)("p",[(0,l.h)("span.percentage",u+"%"),c(i)]))),r.push((0,l.h)("div.bar-back",(0,l.h)("div.bar",{attributes:{style:"width:"+u+"%"}}))),a&&r.push(o.attach("discourse-poll-voters",{postId:t.post.id,optionId:i.id,pollName:n.get("name"),totalVotes:i.votes,voters:e.voters&&e.voters[i.id]||[]})),(0,l.h)("li",{className:p?"chosen":""},r)})}}}),(0,e.createWidget)("discourse-poll-number-results",{buildKey:function(t){return"poll-number-results-"+t.id},defaultState:function(){return{loaded:!1}},fetchVoters:function(){var t=this,e=this.attrs,l=this.state;return f({post_id:e.post.id,poll_name:e.poll.get("name")}).then(function(e){l.voters=e.voters,t.scheduleRerender()})},html:function(t,e){var o=t.poll,i=o.get("options").reduce(function(t,e){return t+parseInt(e.html,10)*parseInt(e.votes,10)},0),s=o.get("voters"),r=0===s?0:(0,u.default)(i/s,-2),a=I18n.t("poll.average_rating",{average:r}),p=[(0,l.h)("div.poll-results-number-rating",new n.default({html:"<span>"+a+"</span>"}))];return o.get("public")&&(e.loaded||(e.voters=o.get("preloaded_voters"),e.loaded=!0),p.push(this.attach("discourse-poll-voters",{totalVotes:o.get("voters"),voters:e.voters||[],postId:t.post.id,pollName:o.get("name"),pollType:o.get("type")}))),p}}),(0,e.createWidget)("discourse-poll-container",{tagName:"div.poll-container",html:function(t){var e=this,o=t.poll,n=o.get("options");if(t.showResults){var i="number"===o.get("type")?"number":"standard";return this.attach("discourse-poll-"+i+"-results",t)}if(n)return(0,l.h)("ul",n.map(function(l){return e.attach("discourse-poll-option",{option:l,isMultiple:t.isMultiple,vote:t.vote})}))}}),(0,e.createWidget)("discourse-poll-info",{tagName:"div.poll-info",multipleHelpText:function(t,e,l){if(e>0)if(t===e){if(t>1)return I18n.t("poll.multiple.help.x_options",{count:t})}else{if(t>1)return e<l?I18n.t("poll.multiple.help.between_min_and_max_options",{min:t,max:e}):I18n.t("poll.multiple.help.at_least_min_options",{count:t});if(e<=l)return I18n.t("poll.multiple.help.up_to_max_options",{count:e})}},html:function(t){var e=t.poll,o=e.get("voters"),n=[(0,l.h)("p",[(0,l.h)("span.info-number",o.toString()),(0,l.h)("span.info-label",I18n.t("poll.voters",{count:o}))])];if(t.isMultiple)if(t.showResults||t.isClosed){var i=e.get("options").reduce(function(t,e){return t+parseInt(e.votes,10)},0);n.push((0,l.h)("p",[(0,l.h)("span.info-number",i.toString()),(0,l.h)("span.info-label",I18n.t("poll.total_votes",{count:i}))]))}else{var s=this.multipleHelpText(t.min,t.max,e.get("options.length"));s&&n.push(d(s))}return t.isClosed||t.showResults||!e.get("public")||n.push(d(I18n.t("poll.public.title"))),n}}),(0,e.createWidget)("discourse-poll-buttons",{tagName:"div.poll-buttons",html:function(t){var e=[],l=t.poll,o=t.post,i=o.get("topic.archived"),s=t.isClosed,r=s||i;if(t.isMultiple&&!r){var a=!t.canCastVotes;e.push(this.attach("button",{className:"btn cast-votes "+(a?"btn-default":"btn-primary"),label:"poll.cast-votes.label",title:"poll.cast-votes.title",disabled:a,action:"castVotes"})),e.push(" ")}if(t.showResults||r?e.push(this.attach("button",{className:"btn btn-default toggle-results",label:"poll.hide-results.label",title:"poll.hide-results.title",icon:"far-eye-slash",disabled:r,action:"toggleResults"})):"on_vote"!==l.get("results")||t.hasVoted?"on_close"!==l.get("results")||s?e.push(this.attach("button",{className:"btn btn-default toggle-results",label:"poll.show-results.label",title:"poll.show-results.title",icon:"far-eye",disabled:0===l.get("voters"),action:"toggleResults"})):e.push(d(I18n.t("poll.results.closed.title"))):e.push(d(I18n.t("poll.results.vote.title"))),l.get("close")){var u=moment.utc(l.get("close"));if(u.isValid()){var c=u.format("LLL"),f=void 0;if(t.isAutomaticallyClosed){var h=(0,p.relativeAge)(u.toDate(),{addAgo:!0});f=I18n.t("poll.automatic_close.age",{age:h})}else{var m=moment().to(u.local(),!0);f=I18n.t("poll.automatic_close.closes_in",{timeLeft:m})}e.push(new n.default({html:'<span class="info-text" title="'+c+'">'+f+"</span>"}))}}return!this.currentUser||this.currentUser.get("id")!==o.get("user_id")&&!this.currentUser.get("staff")||i||(s?t.isAutomaticallyClosed||e.push(this.attach("button",{className:"btn btn-default toggle-status",label:"poll.open.label",title:"poll.open.title",icon:"unlock-alt",action:"toggleStatus"})):e.push(this.attach("button",{className:"btn toggle-status btn-danger",label:"poll.close.label",title:"poll.close.title",icon:"lock",action:"toggleStatus"}))),e}}),t.default=(0,e.createWidget)("discourse-poll",{tagName:"div.poll",buildKey:function(t){return"poll-"+t.id},buildAttributes:function(t){return{"data-poll-name":t.poll.get("name"),"data-poll-type":t.poll.get("type")}},defaultState:function(t){var e=t.post,l=t.poll;return{loading:!1,showResults:e.get("topic.archived")||this.isClosed()||"on_close"!==l.get("results")&&this.hasVoted()}},html:function(t,e){var o=e.showResults||t.post.get("topic.archived")||this.isClosed(),n=jQuery.extend({},t,{canCastVotes:this.canCastVotes(),hasVoted:this.hasVoted(),isAutomaticallyClosed:this.isAutomaticallyClosed(),isClosed:this.isClosed(),isMultiple:this.isMultiple(),max:this.max(),min:this.min(),showResults:o});return(0,l.h)("div",[this.attach("discourse-poll-container",n),this.attach("discourse-poll-info",n),this.attach("discourse-poll-buttons",n)])},min:function(){var t=parseInt(this.attrs.poll.get("min"),10);return(isNaN(t)||t<0)&&(t=0),t},max:function(){var t=parseInt(this.attrs.poll.get("max"),10),e=this.attrs.poll.get("options.length");return(isNaN(t)||t>e)&&(t=e),t},isAutomaticallyClosed:function(){var t=this.attrs.poll;return t.get("close")&&moment.utc(t.get("close"))<=moment()},isClosed:function(){return"closed"===this.attrs.poll.get("status")||this.isAutomaticallyClosed()},isMultiple:function(){return"multiple"===this.attrs.poll.get("type")},hasVoted:function(){var t=this.attrs.vote;return t&&t.length>0},canCastVotes:function(){var t=this.state,e=this.attrs;if(this.isClosed()||t.showResults||t.loading)return!1;var l=e.vote.length;return this.isMultiple()?l>=this.min()&&l<=this.max():l>0},toggleStatus:function(){var t=this,e=this.state,l=this.attrs,o=l.post,n=l.poll;this.isAutomaticallyClosed()||bootbox.confirm(I18n.t(this.isClosed()?"poll.open.confirm":"poll.close.confirm"),I18n.t("no_value"),I18n.t("yes_value"),function(l){if(l){e.loading=!0;var r=t.isClosed()?"open":"closed";(0,i.ajax)("/polls/toggle_status",{type:"PUT",data:{post_id:o.get("id"),poll_name:n.get("name"),status:r}}).then(function(){n.set("status",r),"on_close"===n.get("results")&&(e.showResults="closed"===r),t.scheduleRerender()}).catch(function(t){t?(0,s.popupAjaxError)(t):bootbox.alert(I18n.t("poll.error_while_toggling_status"))}).finally(function(){e.loading=!1})}})},toggleResults:function(){this.state.showResults=!this.state.showResults},showLogin:function(){this.register.lookup("route:application").send("showLogin")},toggleOption:function(t){var e=this.attrs;if(!this.isClosed()){if(!this.currentUser)return this.showLogin();var l=e.vote,o=l.indexOf(t.id);return this.isMultiple()||(l.length=0),-1!==o?l.splice(o,1):l.push(t.id),this.isMultiple()?void 0:this.castVotes()}},castVotes:function(){if(this.canCastVotes()){if(!this.currentUser)return this.showLogin();var t=this.attrs,e=this.state;return e.loading=!0,(0,i.ajax)("/polls/vote",{type:"PUT",data:{post_id:t.post.id,poll_name:t.poll.get("name"),options:t.vote}}).then(function(l){var o=l.poll;t.poll.setProperties(o),"on_close"!==t.poll.get("results")&&(e.showResults=!0)}).catch(function(t){t?(0,s.popupAjaxError)(t):bootbox.alert(I18n.t("poll.error_while_casting_votes"))}).finally(function(){e.loading=!1})}}})}),define("discourse/plugins/poll/lib/even-round",["exports"],function(t){"use strict";function e(t){return 100===t.map(function(t){return Math.floor(t)}).reduce(function(t,e){return t+e})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(t){for(var l=t.map(function(t){return t%1}),o=Math.ceil(l.reduce(function(t,e){return t+e})),n=0,i=l.length;n<o&&n<i;n++){for(var s=0,r=0,a=0;a<l.length;a++)l[a]>s&&(r=a,s=l[a]);if(++t[r],l[r]=0,e(t))break}return t.map(function(t){return Math.floor(t)})}}),define("discourse/plugins/poll/lib/discourse-markdown/poll",["exports"],function(t){"use strict";function e(t){if(Array.isArray(t)){for(var e=0,l=Array(t.length);e<t.length;e++)l[e]=t[e];return l}return Array.from(t)}function l(t,l,o){var n=t.indexOf(l),i=t[n].level;for(t.splice.apply(t,[n,1].concat(e(o))),o[0].map=l.map;n<t.length;n++){var s=t[n].nesting;s<0&&i--,t[n].level=i,s>0&&i++}}function o(t,e){for(var l=t.length-1,o=[],n=[];t[l]!==e;l--){if(0===l)return;var i=t[l];if(0===i.level&&"ol"!==i.tag&&"ul"!==i.tag)return;if(1===i.level&&1===i.nesting){if("li"!==i.tag)return;o.push([i,n.reverse().join(" ")])}1===i.level&&1===i.nesting&&"li"===i.tag?n=[]:"text"!==i.type&&"inline"!==i.type||n.push(i.content)}return o.reverse()}function n(t,e){t.push("text","",0).content="[/"+e+"]"}function i(t){t.registerOptions(function(t,e){t.features.poll=!!e.poll_enabled,t.pollMaximumOptions=e.poll_maximum_options}),t.registerPlugin(function(t){t.block.bbcode.ruler.push("poll",y)})}function s(t){t.whiteList(["div.poll","div.poll-info","div.poll-container","div.poll-buttons","div[data-*]","span.info-number","span.info-text","span.info-label","a.button.cast-votes","a.button.toggle-results","li[data-*]"]),i(t)}function r(t,e){var l=t[0],o=t[1],n=t[2],i=t[3];l=u(l,o,n,i,e[0],7,-680876936),i=u(i,l,o,n,e[1],12,-389564586),n=u(n,i,l,o,e[2],17,606105819),o=u(o,n,i,l,e[3],22,-1044525330),l=u(l,o,n,i,e[4],7,-176418897),i=u(i,l,o,n,e[5],12,1200080426),n=u(n,i,l,o,e[6],17,-1473231341),o=u(o,n,i,l,e[7],22,-45705983),l=u(l,o,n,i,e[8],7,1770035416),i=u(i,l,o,n,e[9],12,-1958414417),n=u(n,i,l,o,e[10],17,-42063),o=u(o,n,i,l,e[11],22,-1990404162),l=u(l,o,n,i,e[12],7,1804603682),i=u(i,l,o,n,e[13],12,-40341101),n=u(n,i,l,o,e[14],17,-1502002290),o=u(o,n,i,l,e[15],22,1236535329),l=p(l,o,n,i,e[1],5,-165796510),i=p(i,l,o,n,e[6],9,-1069501632),n=p(n,i,l,o,e[11],14,643717713),o=p(o,n,i,l,e[0],20,-373897302),l=p(l,o,n,i,e[5],5,-701558691),i=p(i,l,o,n,e[10],9,38016083),n=p(n,i,l,o,e[15],14,-660478335),o=p(o,n,i,l,e[4],20,-405537848),l=p(l,o,n,i,e[9],5,568446438),i=p(i,l,o,n,e[14],9,-1019803690),n=p(n,i,l,o,e[3],14,-187363961),o=p(o,n,i,l,e[8],20,1163531501),l=p(l,o,n,i,e[13],5,-1444681467),i=p(i,l,o,n,e[2],9,-51403784),n=p(n,i,l,o,e[7],14,1735328473),o=p(o,n,i,l,e[12],20,-1926607734),l=c(l,o,n,i,e[5],4,-378558),i=c(i,l,o,n,e[8],11,-2022574463),n=c(n,i,l,o,e[11],16,1839030562),o=c(o,n,i,l,e[14],23,-35309556),l=c(l,o,n,i,e[1],4,-1530992060),i=c(i,l,o,n,e[4],11,1272893353),n=c(n,i,l,o,e[7],16,-155497632),o=c(o,n,i,l,e[10],23,-1094730640),l=c(l,o,n,i,e[13],4,681279174),i=c(i,l,o,n,e[0],11,-358537222),n=c(n,i,l,o,e[3],16,-722521979),o=c(o,n,i,l,e[6],23,76029189),l=c(l,o,n,i,e[9],4,-640364487),i=c(i,l,o,n,e[12],11,-421815835),n=c(n,i,l,o,e[15],16,530742520),o=c(o,n,i,l,e[2],23,-995338651),l=d(l,o,n,i,e[0],6,-198630844),i=d(i,l,o,n,e[7],10,1126891415),n=d(n,i,l,o,e[14],15,-1416354905),o=d(o,n,i,l,e[5],21,-57434055),l=d(l,o,n,i,e[12],6,1700485571),i=d(i,l,o,n,e[3],10,-1894986606),n=d(n,i,l,o,e[10],15,-1051523),o=d(o,n,i,l,e[1],21,-2054922799),l=d(l,o,n,i,e[8],6,1873313359),i=d(i,l,o,n,e[15],10,-30611744),n=d(n,i,l,o,e[6],15,-1560198380),o=d(o,n,i,l,e[13],21,1309151649),l=d(l,o,n,i,e[4],6,-145523070),i=d(i,l,o,n,e[11],10,-1120210379),n=d(n,i,l,o,e[2],15,718787259),o=d(o,n,i,l,e[9],21,-343485551),t[0]=v(l,t[0]),t[1]=v(o,t[1]),t[2]=v(n,t[2]),t[3]=v(i,t[3])}function a(t,e,l,o,n,i){return e=v(v(e,t),v(o,i)),v(e<<n|e>>>32-n,l)}function u(t,e,l,o,n,i,s){return a(e&l|~e&o,t,e,n,i,s)}function p(t,e,l,o,n,i,s){return a(e&o|l&~o,t,e,n,i,s)}function c(t,e,l,o,n,i,s){return a(e^l^o,t,e,n,i,s)}function d(t,e,l,o,n,i,s){return a(l^(e|~o),t,e,n,i,s)}function f(t){/[\x80-\xFF]/.test(t)&&(t=unescape(encodeURI(t)));var e,l=t.length,o=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)r(o,h(t.substring(e-64,e)));t=t.substring(e-64);var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)n[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(r(o,n),e=0;e<16;e++)n[e]=0;return n[14]=8*l,r(o,n),o}function h(t){var e,l=[];for(e=0;e<64;e+=4)l[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return l}function m(t){for(var e="",l=0;l<4;l++)e+=O[t>>8*l+4&15]+O[t>>8*l&15];return e}function b(t){for(var e=0;e<t.length;e++)t[e]=m(t[e]);return t.join("")}function v(t,e){return t+e&4294967295}function g(t){return b(f(t))}Object.defineProperty(t,"__esModule",{value:!0}),t.setup=s;var _=["close","max","min","name","order","public","results","status","step","type"],y={tag:"poll",before:function(t,e,l){var o=t.push("text","",0);o.content=l,o.bbcode_attrs=e.attrs,o.bbcode_type="poll_open"},after:function(t,e,i){var s=o(t.tokens,e);if(!s)return n(t,i);var r=e.bbcode_attrs,a=[["class","poll"]];r.status||a.push(["data-poll-status","open"]),_.forEach(function(t){r[t]&&a.push(["data-poll-"+t,r[t]])}),r.name||a.push(["data-poll-name","poll"]);var u=parseInt(r.min,10),p=parseInt(r.max,10),c=parseInt(r.step,10);c<1&&(c=1);var d=[],f=new t.Token("poll_open","div",1);if(f.block=!0,f.attrs=a,d.push(f),f=new t.Token("poll_open","div",1),f.block=!0,d.push(f),f=new t.Token("poll_open","div",1),f.attrs=[["class","poll-container"]],d.push(f),"number"===r.type){if(isNaN(u)&&(u=1),isNaN(p)&&(p=t.md.options.discourse.pollMaximumOptions),isNaN(c)&&(c=1),s.length>0)return n(t,i);f=new t.Token("bullet_list_open","ul",1),d.push(f);for(var h=u;h<=p;h+=c)f=new t.Token("list_item_open","li",1),s.push([f,String(h)]),d.push(f),f=new t.Token("text","",0),f.content=String(h),d.push(f),f=new t.Token("list_item_close","li",-1),d.push(f);f=new t.Token("bullet_item_close","",-1),d.push(f)}for(var m=0;m<s.length;m++){f=s[m][0];var b=s[m][1];f.attrs=f.attrs||[];var v=g(JSON.stringify([b]));f.attrs.push(["data-poll-option-id",v])}l(t.tokens,e,d),t.level=t.tokens[t.tokens.length-1].level,t.push("poll_close","div",-1),f=t.push("poll_open","div",1),f.attrs=[["class","poll-info"]],t.push("paragraph_open","p",1),f=t.push("span_open","span",1),f.block=!1,f.attrs=[["class","info-number"]],f=t.push("text","",0),f.content="0",t.push("span_close","span",-1),f=t.push("span_open","span",1),f.block=!1,f.attrs=[["class","info-label"]],f=t.push("text","",0),f.content=I18n.t("poll.voters",{count:0}),t.push("span_close","span",-1),t.push("paragraph_close","p",-1),t.push("poll_close","div",-1),t.push("poll_close","div",-1),t.push("poll_close","div",-1)}},O="0123456789abcdef".split("")}),define("discourse/plugins/poll/initializers/add-poll-ui-builder",["exports","discourse/lib/plugin-api","ember-addons/ember-computed-decorators","discourse/lib/show-modal"],function(t,e,l,o){"use strict";function n(t,e,l,o,n){var i={};return Object.keys(o).forEach(function(t){i[t]=o[t]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=l.slice().reverse().reduce(function(l,o){return o(t,e,l)||l},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(t,e,i),i=null),i}function i(t){var e,i;t.modifyClass("controller:composer",(e=(0,l.default)("siteSettings.poll_enabled","siteSettings.poll_minimum_trust_level_to_create","model.topic.pm_with_non_human_user"),i={canBuildPoll:function(t,e,l){return t&&(l||this.currentUser&&(this.currentUser.staff||this.currentUser.trust_level>=e))},actions:{showPollBuilder:function(){(0,o.default)("poll-ui-builder").set("toolbarEvent",this.toolbarEvent)}}},n(i,"canBuildPoll",[e],Object.getOwnPropertyDescriptor(i,"canBuildPoll"),i),i)),t.addToolbarPopupMenuOptionsCallback(function(){return{action:"showPollBuilder",icon:"chart-bar",label:"poll.ui_builder.title",condition:"canBuildPoll"}})}Object.defineProperty(t,"__esModule",{value:!0}),t.default={name:"add-poll-ui-builder",initialize:function(){(0,e.withPluginApi)("0.8.7",i)}}}),define("discourse/plugins/poll/initializers/extend-for-poll",["exports","discourse/lib/plugin-api","ember-addons/ember-computed-decorators","discourse-common/lib/get-owner","discourse/widgets/glue"],function(t,e,l,o,n){"use strict";function i(t,e,l,o,n){var i={};return Object.keys(o).forEach(function(t){i[t]=o[t]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=l.slice().reverse().reduce(function(l,o){return o(t,e,l)||l},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(t,e,i),i=null),i}function s(t){function e(){c.forEach(function(t){return t.queueRerender()})}function s(l,o){var i=$(".poll",l);if(i.length&&o){var s=o.getModel();t.preventCloak(s.id);var r=s.get("polls_votes")||{};s.pollsChanged();var a=s.get("pollsObject");a&&(d=d||setInterval(e,3e4),i.each(function(t,e){var l=$(e),o=l.data("poll-name"),i=a[o];if(i){var u=new n.default("discourse-poll",p,{id:o+"-"+s.id,post:s,poll:i,vote:r[o]||[]});u.appendTo(e),c.push(u)}}))}}function r(){d&&(clearInterval(d),d=null),c.forEach(function(t){return t.cleanUp()}),c=[]}var a,u,p=(0,o.getRegister)(t);t.modifyClass("controller:topic",{subscribe:function(){var t=this;this._super.apply(this,arguments),this.messageBus.subscribe("/polls/"+this.get("model.id"),function(e){var l=t.get("model.postStream").findLoadedPost(e.post_id);l&&l.set("polls",e.polls)})},unsubscribe:function(){this.messageBus.unsubscribe("/polls/*"),this._super.apply(this,arguments)}});var c=[],d=null;t.modifyClass("model:post",(a=(0,l.observes)("polls"),u={_polls:null,pollsObject:null,pollsChanged:function(){var t=this,l=this.polls;l&&(this._polls=this._polls||{},l.forEach(function(e){t._polls[e.name]?t._polls[e.name].setProperties(e):t._polls[e.name]=Ember.Object.create(e)}),this.set("pollsObject",this._polls),e())}},i(u,"pollsChanged",[a],Object.getOwnPropertyDescriptor(u,"pollsChanged"),u),u)),t.includePostAttributes("polls","polls_votes"),t.decorateCooked(s,{onlyStream:!0,id:"discourse-poll"}),t.cleanupStream(r)}Object.defineProperty(t,"__esModule",{value:!0}),t.default={name:"extend-for-poll",initialize:function(){(0,e.withPluginApi)("0.8.7",s)}}}),define("discourse/plugins/poll/controllers/poll-ui-builder",["exports","ember-addons/ember-computed-decorators","discourse/models/input-validation"],function(t,e,l){"use strict";function o(t,e,l,o,n){var i={};return Object.keys(o).forEach(function(t){i[t]=o[t]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=l.slice().reverse().reduce(function(l,o){return o(t,e,l)||l},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(t,e,i),i=null),i}Object.defineProperty(t,"__esModule",{value:!0});var n,i,s,r,a,u,p,c,d,f,h,m,b,v,g,y,O;t.default=Ember.Controller.extend((n=(0,e.default)("regularPollType","numberPollType","multiplePollType"),i=(0,e.default)("alwaysPollResult","votePollResult","closedPollResult"),s=(0,e.default)("pollType","regularPollType"),r=(0,e.default)("pollType","pollOptionsCount","multiplePollType"),a=(0,e.default)("pollType","numberPollType"),u=(0,e.default)("isRegular"),p=(0,e.default)("pollOptions"),c=(0,e.observes)("isMultiple","isNumber","pollOptionsCount"),d=(0,e.default)("isRegular","isMultiple","isNumber","pollOptionsCount"),f=(0,e.default)("isRegular","isMultiple","isNumber","pollOptionsCount","pollMin","pollStep"),h=(0,e.default)("isNumber","pollMax"),m=(0,e.default)("isNumber","showMinMax","pollType","pollResult","publicPoll","pollOptions","pollMin","pollMax","pollStep","autoClose","date","time"),b=(0,e.default)("pollOptionsCount","isRegular","isMultiple","isNumber","pollMin","pollMax"),v=(0,e.default)("pollMin","pollMax"),g=(0,e.default)("pollStep"),y=(0,e.default)("disableInsert"),O={regularPollType:"regular",numberPollType:"number",multiplePollType:"multiple",alwaysPollResult:"always",votePollResult:"on_vote",closedPollResult:"on_close",init:function(){this._super.apply(this,arguments),this._setupPoll()},pollTypes:function(t,e,l){return[{name:I18n.t("poll.ui_builder.poll_type.regular"),value:t},{name:I18n.t("poll.ui_builder.poll_type.number"),value:e},{name:I18n.t("poll.ui_builder.poll_type.multiple"),value:l}]},pollResults:function(t,e,l){return[{name:I18n.t("poll.ui_builder.poll_result.always"),value:t},{name:I18n.t("poll.ui_builder.poll_result.vote"),value:e},{name:I18n.t("poll.ui_builder.poll_result.closed"),value:l}]},isRegular:function(t,e){return t===e},isMultiple:function(t,e,l){return t===l&&e>0},isNumber:function(t,e){return t===e},showMinMax:function(t){return!t},pollOptionsCount:function(t){if(0===t.length)return 0;var e=0;return t.split("\n").forEach(function(t){0!==t.length&&(e+=1)}),e},_setPollMax:function(){var t=this.isMultiple,e=this.isNumber;(t||e)&&(t?this.set("pollMax",this.pollOptionsCount):e&&this.set("pollMax",this.siteSettings.poll_maximum_options))},pollMinOptions:function(t,e,l,o){if(!t)return e?this._comboboxOptions(1,o+1):l?this._comboboxOptions(1,this.siteSettings.poll_maximum_options+1):void 0},pollMaxOptions:function(t,e,l,o,n,i){if(!t){var s=parseInt(n)||1;if(e)return this._comboboxOptions(s+1,o+1);if(l){var r=parseInt(i,10);return r<1&&(r=1),this._comboboxOptions(s+1,s+this.siteSettings.poll_maximum_options*r)}}},pollStepOptions:function(t,e){if(t)return this._comboboxOptions(1,(parseInt(e)||1)+1)},pollOutput:function(t,e,l,o,n,i,s,r,a,u,p,c){var d="[poll",f="",h=this.toolbarEvent.getText().match(/\[poll(\s+name=[^\s\]]+)*.*\]/gim);h&&(d+=" name=poll"+(h.length+1));var m=a;if(m<1&&(m=1),l&&(d+=" type="+l),o&&(d+=" results="+o),s&&e&&(d+=" min="+s),r&&(d+=" max="+r),t&&(d+=" step="+m),n&&(d+=" public=true"),u){var b=moment(p+" "+c,"YYYY-MM-DD HH:mm").toISOString();b&&(d+=" close="+b)}return d+="]",f+=d+"\n",i.length>0&&!t&&i.split("\n").forEach(function(t){0!==t.length&&(f+="* "+t+"\n")}),f+="[/poll]"},disableInsert:function(t,e,l,o,n,i){return e&&t<2||l&&t<n&&n>=i||!o&&t<2},minMaxValueValidation:function(t,e){var o={ok:!0};return t>=e&&(o={failed:!0,reason:I18n.t("poll.ui_builder.help.invalid_values")}),l.default.create(o)},minStepValueValidation:function(t){var e={ok:!0};return t<1&&(e={failed:!0,reason:I18n.t("poll.ui_builder.help.min_step_value")}),l.default.create(e)},minNumOfOptionsValidation:function(t){var e={ok:!0};return t&&(e={failed:!0,reason:I18n.t("poll.ui_builder.help.options_count")}),l.default.create(e)},_comboboxOptions:function(t,e){return _.range(t,e).map(function(t){return{value:t,name:t}})},_setupPoll:function(){this.setProperties({pollType:null,publicPoll:!1,pollOptions:"",pollMin:1,pollMax:null,pollStep:1,autoClose:!1,date:moment().add(1,"day").format("YYYY-MM-DD"),time:moment().add(1,"hour").format("HH:mm")})},actions:{insertPoll:function(){this.toolbarEvent.addText(this.pollOutput),this.send("closeModal"),this._setupPoll()}}},o(O,"pollTypes",[n],Object.getOwnPropertyDescriptor(O,"pollTypes"),O),o(O,"pollResults",[i],Object.getOwnPropertyDescriptor(O,"pollResults"),O),o(O,"isRegular",[s],Object.getOwnPropertyDescriptor(O,"isRegular"),O),o(O,"isMultiple",[r],Object.getOwnPropertyDescriptor(O,"isMultiple"),O),o(O,"isNumber",[a],Object.getOwnPropertyDescriptor(O,"isNumber"),O),o(O,"showMinMax",[u],Object.getOwnPropertyDescriptor(O,"showMinMax"),O),o(O,"pollOptionsCount",[p],Object.getOwnPropertyDescriptor(O,"pollOptionsCount"),O),o(O,"_setPollMax",[c],Object.getOwnPropertyDescriptor(O,"_setPollMax"),O),o(O,"pollMinOptions",[d],Object.getOwnPropertyDescriptor(O,"pollMinOptions"),O),
o(O,"pollMaxOptions",[f],Object.getOwnPropertyDescriptor(O,"pollMaxOptions"),O),o(O,"pollStepOptions",[h],Object.getOwnPropertyDescriptor(O,"pollStepOptions"),O),o(O,"pollOutput",[m],Object.getOwnPropertyDescriptor(O,"pollOutput"),O),o(O,"disableInsert",[b],Object.getOwnPropertyDescriptor(O,"disableInsert"),O),o(O,"minMaxValueValidation",[v],Object.getOwnPropertyDescriptor(O,"minMaxValueValidation"),O),o(O,"minStepValueValidation",[g],Object.getOwnPropertyDescriptor(O,"minStepValueValidation"),O),o(O,"minNumOfOptionsValidation",[y],Object.getOwnPropertyDescriptor(O,"minNumOfOptionsValidation"),O),O))});
//# sourceMappingURL=/assets/plugins/poll-c7ab9de1ceaf3d5c1a1c4502e1b376393397a01eaac100909bd2a9bf79d85953.js.map
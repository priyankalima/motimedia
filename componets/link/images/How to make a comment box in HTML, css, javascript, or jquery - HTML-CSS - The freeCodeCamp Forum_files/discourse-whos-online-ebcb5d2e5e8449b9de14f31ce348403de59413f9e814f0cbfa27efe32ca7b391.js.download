Ember.TEMPLATES["javascripts/connectors/discovery-list-container-top/online_users_widget"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[23,"whos-online"],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/connectors/discovery-list-container-top/online_users_widget"}}),Ember.TEMPLATES["javascripts/components/whos-online"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[25,["showWhosOnline"]]],null,{"statements":[[0,"    "],[7,"div"],[11,"id","whos-online"],[12,"class",[30,[[29,"if",[[25,["isLong"]],"collapsed"],null]]]],[9],[0,"\\n        "],[7,"span"],[12,"title",[30,[[29,"i18n",["whos_online.tooltip"],null]]]],[9],[0,"\\n"],[4,"if",[[25,["isUsers"]]],null,{"statements":[[0,"        \\t\\t"],[1,[29,"i18n",["whos_online.title"],[["count"],[[25,["online","users","length"]]]]],false],[0,"\\n"]],"parameters":[]},{"statements":[[0,"        \\t\\t"],[1,[29,"i18n",["whos_online.no_users"],null],false],[0,"\\n"]],"parameters":[]}],[0,"        "],[10],[0,"\\n"],[4,"if",[[25,["isUsers"]]],null,{"statements":[[4,"each",[[25,["users"]]],null,{"statements":[[0,"        \\t\\t"],[1,[29,"whos-online-avatar",null,[["user"],[[24,1,[]]]]],false],[0,"\\n"]],"parameters":[1]},null]],"parameters":[]},null],[0,"    "],[10],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/components/whos-online"}}),Ember.TEMPLATES["javascripts/components/whos-online-avatar"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[29,"avatar",[[25,["user"]]],[["avatarTemplatePath","title","imageSize"],["avatar_template",[25,["user","username"]],"small"]]],false]],"hasEval":false}',meta:{moduleName:"javascripts/components/whos-online-avatar"}}),define("discourse/plugins/discourse-whos-online/discourse/components/whos-online",["exports","ember"],function(e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=s.default.inject;e.default=s.default.Component.extend({showWhosOnline:function(){return!(this.get("online").users.length<this.siteSettings.whos_online_minimum_display&&this.siteSettings.whos_online_hide_below_minimum_display)&&this.get("online").get("shouldDisplay")}.property(),online:n.service("online-service"),users:function(){return this.get("online").users.slice(0,this.siteSettings.whos_online_maximum_display)}.property("online.users.@each"),isLong:function(){return this.get("online").users.length>=this.siteSettings.whos_online_collapse_threshold}.property("online.users.length"),isUsers:function(){return this.get("online").users.length>=this.siteSettings.whos_online_minimum_display}.property("online.users.length")})}),define("discourse/plugins/discourse-whos-online/discourse/components/whos-online-avatar",["exports","ember"],function(e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=s.default.Component.extend({tagName:"a",attributeBindings:["user.username:data-user-card","user.path:href"]})}),define("discourse/plugins/discourse-whos-online/discourse/services/online-service",["exports","ember","discourse/lib/ajax","discourse/models/user"],function(e,s,n,i){"use strict";function t(e){if(Array.isArray(e)){for(var s=0,n=Array(e.length);s<e.length;s++)n[s]=e[s];return n}return Array.from(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=s.default.Service.extend({after:"message-bus",messageBus:window.MessageBus,users:[],appEvents:Discourse.__container__.lookup("app-events:main"),siteSettings:Discourse.__container__.lookup("site-settings:main"),_lastMessageId:null,isUserOnline:function(e){var s=function(e){return e.id===this};return void 0!==this.get("users").find(s,e)},messageProcessor:function(){var e=this;return function(s,r,o){var a=e.get("users");if(o!==e.get("_lastMessageId")+1)return e.messageBus.unsubscribe("/whos-online",this.func),void(0,n.ajax)("/whosonline/get.json",{method:"GET"}).then(function(s){var n=a.map(function(e){return e.get("id")});e.set("users",s.users.map(function(e){return i.default.create(e)}));var r=e.get("users").map(function(e){return e.get("id")});e.set("_lastMessageId",s.messagebus_id),e.messageBus.subscribe("/whos-online",e.messageProcessor(),s.messagebus_id);var o=[].concat(t(n),t(r));e.appEvents.trigger("whosonline:changed",o)},function(e){console.log(e)});switch(e.set("_lastMessageId",o),s.message_type){case"going_online":var l=i.default.create(s.user);a.pushObject(l),e.appEvents.trigger("whosonline:changed",[l.get("id")]);break;case"going_offline":var u=function(e){return e.get("id")===this};s.users.forEach(function(e){var s=a.find(u,e);void 0!==s&&a.removeObject(s)}),e.appEvents.trigger("whosonline:changed",s.users);break;default:console.error("Unknown message type sent to /whos-online")}}},init:function(){var e=Discourse.Site.currentProp("users_online");e&&(this.set("users",e.users.map(function(e){return i.default.create(e)})),this.set("_lastMessageId",e.messagebus_id),this.appEvents.trigger("whosonline:changed",e.users.map(function(e){return e.id})),this.messageBus.subscribe("/whos-online",this.messageProcessor(),e.messagebus_id))},shouldDisplay:function(){if(!this.siteSettings.whos_online_enabled)return!1;if(this.siteSettings.whos_online_display_public)return!0;var e=Discourse.User.current();return null!==e&&e.trust_level>=this.siteSettings.whos_online_display_min_trust_level}.property()})}),define("discourse/plugins/discourse-whos-online/discourse/initializers/start-whos-online",["exports","discourse/lib/plugin-api"],function(e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=Ember.inject;e.default={name:"start-whos-online",initialize:function(e){var i=e.lookup("service:online-service"),t=e.lookup("site-settings:main");if(i.get("shouldDisplay")){var r=t.whos_online_avatar_indicator;"none"!==r&&($("html").addClass("whos-online-"+r),(0,s.withPluginApi)("0.2",function(e){e.modifyClass("component:user-card-contents",{onlineService:n.service("online-service"),classNameBindings:["isOnline:user-online"],isOnline:function(){return!!this.get("user")&&this.get("onlineService").isUserOnline(this.get("user").id)}.property("onlineService.users.@each","user")}),e.modifyClass("route:user",{onlineService:n.service("online-service"),afterModel:function(){return this.updateBodyClass(),this._super()},updateBodyClass:function(){var e=this.modelFor("user").id;this.get("onlineService").isUserOnline(e)?Ember.$("body").addClass("user-page-online"):Ember.$("body").removeClass("user-page-online")}.observes("onlineService.users.@each"),deactivate:function(){this._super(),Ember.$("body").removeClass("user-page-online")}}),t.whos_online_avatar_indicator_topic_lists&&(e.modifyClass("component:topic-list-item",{onlineService:n.service("online-service"),classNameBindings:["isOnline:last-poster-online"],isOnline:function(){return this.get("onlineService").isUserOnline(this.get("topic.lastPoster.id"))}.property("onlineService.users.@each","user")}),e.modifyClass("component:latest-topic-list-item",{onlineService:n.service("online-service"),classNameBindings:["isOnline:last-poster-online"],isOnline:function(){return this.get("onlineService").isUserOnline(this.get("topic.lastPoster.id"))}.property("onlineService.users.@each","user")})),e.modifyClass("component:scrolling-post-stream",{didInsertElement:function(){var e=this;this._super(),this.appEvents.on("whosonline:changed",function(s){s.forEach(function(s){e.get("attrs").posts.value.posts.filter(function(e){return e.user_id===s}).map(function(e){return e.id}).forEach(function(n){e.dirtyKeys.keyDirty("post-"+n),e.dirtyKeys.keyDirty("post-"+n+"-avatar-"+s,{onRefresh:"updateOnline"})})}),e.queueRerender()})},willDestroyElement:function(){this.appEvents.off("whosonline:changed")}}),e.reopenWidget("post-avatar",{buildKey:function(e){return"post-"+e.id+"-avatar-"+e.user_id},defaultState:function(e){return{online:i.isUserOnline(e.user_id)}},updateOnline:function(){this.state.online=i.isUserOnline(this.attrs.user_id)},buildClasses:function(e,s){return s.online?"user-online":[]}})}))}}}});
//# sourceMappingURL=/assets/plugins/discourse-whos-online-ebcb5d2e5e8449b9de14f31ce348403de59413f9e814f0cbfa27efe32ca7b391.js.map